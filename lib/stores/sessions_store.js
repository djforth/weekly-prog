(function(global,factory){if('function'==typeof define&&define.amd)define(['exports','events','lodash','../utils/ajax_manager','../factories/date_manager','../utils/sessions_breaker','../dispatchers/sessions_dispatcher'],factory);else if('undefined'!=typeof exports)factory(exports,require('events'),require('lodash'),require('../utils/ajax_manager'),require('../factories/date_manager'),require('../utils/sessions_breaker'),require('../dispatchers/sessions_dispatcher'));else{var mod={exports:{}};factory(mod.exports,global.events,global.lodash,global.ajax_manager,global.date_manager,global.sessions_breaker,global.sessions_dispatcher),global.sessions_store=mod.exports}})(this,function(exports,_events,_lodash,_ajax_manager,_date_manager,_sessions_breaker,_sessions_dispatcher){'use strict';function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function processData(groupBy){var sessions=(0,_date_manager2.default)(groupBy);return function(d,date){var reset=2<arguments.length&&void 0!==arguments[2]&&arguments[2];reset&&sessions.resetDates();var groups=(0,_sessions_breaker2.default)(d,groupBy,date);return _lodash2.default.forEach(_lodash2.default.values(groups),function(ses){sessions.addDate(ses.date,ses.sessions)}),sessions}}function processDates(dates){if(_lodash2.default.isEmpty(dates))return dates;var yesterday=new Date;return yesterday.setDate(yesterday.getDate()-1),_lodash2.default.filter(dates,function(d){return d.date.getTime()>=yesterday.getTime()})}function currentDate(date){var current=_lodash2.default.isDate(date)?date:new Date;return{getDate:function(){return current},setDate:function(d){current=_lodash2.default.isDate(d)?d:current}}}Object.defineProperty(exports,'__esModule',{value:!0});var _lodash2=_interopRequireDefault(_lodash),_ajax_manager2=_interopRequireDefault(_ajax_manager),_date_manager2=_interopRequireDefault(_date_manager),_sessions_breaker2=_interopRequireDefault(_sessions_breaker),_sessions_dispatcher2=_interopRequireDefault(_sessions_dispatcher),ajaxManager=void 0,processor=void 0,sessions=void 0,facility=void 0,fetched=!1,SessionStore=Object.assign({},_events.EventEmitter.prototype,{emitChange:function(event){this.emit(event)},addChangeListener:function(event,callback){this.on(event,callback)},removeChangeListener:function(event,callback){this.removeListener(event,callback)},_addSessions:function(data){_lodash2.default.isFunction(processor)&&(sessions=processor(data))},_calendarChange:function(date){this._setDate(date),this._fetchData(date,!0)},_fetchData:function(date){var _this=this,reset=1<arguments.length&&arguments[1]!==void 0&&arguments[1];if(!ajaxManager)throw new Error('please set API path');ajaxManager.addQuery(date);var request=ajaxManager.fetch();if(request)return request.then(function(data){return fetched=!0,sessions=processor(data,date,reset),_this.emitChange('fetched'),sessions.getAllDates()}).then(function(data){return _this._fetchRest(data),data})},_fetchNowNext:function(){var _this2=this;ajaxManager.fetch().then(function(data){fetched=!0,sessions=processor(data,!1),_this2.emitChange('fetched')})},_fetchRest:function(dates){var fetch=_lodash2.default.filter(dates,function(d){return d.nosessions});fetch=_lodash2.default.reduce(fetch,function(prev,curr){return prev.date.getTime()>curr.date.getTime()?curr:prev}),fetch&&this._fetchData(fetch.date)},_getCurrentDate:function(){return this.current.getDate()},_getDate:function(date){if(this.current||(this.current=currentDate(date)),this.current.setDate(date),sessions){var current_day=sessions.findDate(this.current.getDate());if(current_day)return current_day}if(fetched)this._fetchData(this.current.getDate()),this.emitChange('fetching');else return[];return null},_getFacility:function(){return sessions.findDate(new Date).data.filter('facility',facility)},_getMoreDays:function(){if(fetched){var date=sessions.getMoreDays();_lodash2.default.isDate(date)&&this._fetchData(date)}},_getPreviousDays:function(date){var d=sessions.getPreviousDays(date);_lodash2.default.isDate(d)&&this._fetchData(d)},_getAllDates:function(){return _lodash2.default.isUndefined(sessions)?[new Date]:processDates(sessions.getAllDates())},_setApi:function(api){ajaxManager=(0,_ajax_manager2.default)(api)},_setDate:function(date){this.current||(this.current=currentDate(date)),this.current.setDate(date)},_setFacility:function(id){facility=id},_setGroups:function(groupBy){_lodash2.default.isString(groupBy)&&(processor=processData(groupBy))},_progress:function(prog){_lodash2.default.isFunction(prog)&&(this.progress=prog)}});SessionStore.setMaxListeners(0);SessionStore.dispatchToken=_sessions_dispatcher2.default.register(function registeredCallback(payload){var action=payload.action;switch(action.type){case'CHANGE_DATE':SessionStore._setDate(action.date),SessionStore.emitChange('changing_date');break;case'CALENDAR_CHANGE':SessionStore._calendarChange(action.date),SessionStore.emitChange('calendar_changing');break;case'FETCH_DATA':action.progress&&SessionStore._progress(action.progress),SessionStore._fetchData(action.date),SessionStore.emitChange('fetching');break;case'FETCH_NOWNEXT':action.progress&&SessionStore._progress(action.progress),SessionStore._fetchNowNext(),SessionStore.emitChange('fetching_nownext');break;case'MORE_DAYS':SessionStore._getMoreDays(),SessionStore.emitChange('more_days');break;case'PREVIOUS_DAYS':SessionStore._getPreviousDays(action.date),SessionStore.emitChange('previous_days');break;case'PRERENDER_DATA':SessionStore._addSessions(action.data),SessionStore.emitChange('prerender');break;case'SET_FACILITY':SessionStore._setFacility(action.id),SessionStore.emitChange('set_facility');break;case'SET_GROUPBY':SessionStore._setGroups(action.groupBy),SessionStore.emitChange('groupby');break;case'SET_API':SessionStore._setApi(action.url),SessionStore.emitChange('api_set');break;default:throw new Error('No Action');}}),SessionStore.setMaxListeners(0),exports.default=SessionStore});
//# sourceMappingURL=sessions_store.js.map