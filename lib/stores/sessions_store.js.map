{"version":3,"sources":["../../src/stores/sessions_store.js"],"names":[],"mappings":"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","file":"sessions_store.js","sourcesContent":["const assign      = require(\"react/lib/Object.assign\")\n  , EventEmitter  = require(\"events\").EventEmitter\n  , _             = require(\"lodash\");\n\n//Internal Modules\nconst AjaxManager  = require(\"../utils/ajax_manager\")\n    , DateManager  = require(\"../factories/date_manager\")\n    , SessionsFcty = require(\"../factories/sessions_fcty\")\n    , Breaker      = require(\"../utils/sessions_breaker\");\n\n\n//Flux\nconst SessionsDispatcher = require(\"../dispatchers/sessions_dispatcher\")\n    , SessionsAction     = require(\"../actions/sessions_actions\");\n\nlet ajaxManager, processor, sessions;\n\nfunction processData(groupBy){\n  let sessions = DateManager(groupBy);\n  // console.log('groupBy', groupBy);\n  return function(d){\n    let groups = Breaker(d, groupBy);\n    _.forEach(_.values(groups), (ses)=>{\n      sessions.addDate(ses.date, ses.sessions);\n    });\n\n    return sessions\n  };\n}\n\nfunction currentDate(date){\n  let current = (_.isDate(date)) ? date : new Date();\n\n  return {\n      getDate:()=>current\n    , setDate:(d)=>{\n      current = (_.isDate(d)) ? d : current;\n    }\n  }\n}\n\nconst store = {\n  // <<<<<<<<<<<<<<<< Event management >>>>>>>>>>\n  emitChange(event) {\n    this.emit(event);\n  }\n\n  , addChangeListener(event, callback) {\n    this.on(event, callback);\n  }\n\n  , removeChangeListener(event, callback) {\n    this.removeListener(event, callback);\n  }\n\n  // <<<<<<<<<<<<<<< Fetching and processing session >>>>>>>>>>>>\n  , _addSessions(data){\n    sessions = processor(data);\n  }\n\n  , _fetchData(date){\n    if(!ajaxManager){\n      throw new Error(\"please set API path\")\n    }\n    ajaxManager.setQuery(date);\n    return ajaxManager.fetch().then((data)=>{\n      sessions = processor(data);\n      this.emitChange(\"fetched\");\n    })\n  }\n\n  , _getDate(date){\n    if(!this.current){\n      this.current = currentDate(date);\n    }\n    this.current.setDate(date);\n    if(sessions){\n      let current_day = sessions.findDate(this.current.getDate());\n      if(current_day) return current_day;\n    }\n\n    this._fetchData(this.current.getDate());\n    this.emitChange(\"fetching\");\n\n    return null;\n  }\n\n  , _getTimePeriod(date, tp){\n    //\n  }\n\n  , _setApi(api){\n    ajaxManager = AjaxManager(api);\n  }\n\n  , _setDate(date){\n    if(!this.current){\n      this.current = currentDate(date);\n    }\n    this.current.setDate(date);\n  }\n\n  , _setTimePeriods(){\n\n  }\n\n  , _setGroups(groupBy){\n    // console.log(groupBy)\n    processor = processData(groupBy);\n  }\n};\n\nconst SessionStore = assign({}, EventEmitter.prototype, store);\nSessionStore.setMaxListeners(0);\n\nconst registeredCallback = function(payload) {\n  var action = payload.action;\n  // console.log(action.type)\n  switch(action.type) {\n    case \"CHANGE_DAY\":\n\n      break;\n    case \"GET_TIMEPERIOD\":\n\n      break;\n    case \"FETCH_DATA\":\n\n      break;\n    case \"PRERENDER_DATA\":\n      SessionStore._addSessions(action.data);\n      SessionStore.emitChange(\"prerender\");\n      break;\n    case \"SET_GROUPBY\":\n      // console.log(action.groupBy)\n      SessionStore._setGroups(action.groupBy);\n      SessionStore.emitChange(\"groupby\");\n      break;\n\n  }\n};\n\nSessionStore.dispatchToken = SessionsDispatcher.register(registeredCallback);\n\nmodule.exports = SessionStore;"]}