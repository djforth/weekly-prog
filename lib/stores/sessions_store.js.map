{"version":3,"sources":["../../src/stores/sessions_store.js"],"names":[],"mappings":"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","file":"sessions_store.js","sourcesContent":["const assign      = require(\"react/lib/Object.assign\")\n  , EventEmitter  = require(\"events\").EventEmitter\n  , _             = require(\"lodash/core\");\n\n//Internal Modules\nconst AjaxManager  = require(\"../utils/ajax_manager\")\n    , DateManager  = require(\"../factories/date_manager\")\n    , SessionsFcty = require(\"../factories/sessions_fcty\")\n    , Breaker      = require(\"../utils/sessions_breaker\")\n    , checker      = require(\"../utils/day_checker\");\n\n\n//Flux\nconst SessionsDispatcher = require(\"../dispatchers/sessions_dispatcher\")\n    , SessionsAction     = require(\"../actions/sessions_actions\");\n\nlet ajaxManager, processor, sessions, facility;\n\nlet fetched     = false;\nlet requestMade = false;\n\nfunction processData(groupBy){\n\n  let sessions = DateManager(groupBy);\n\n  return function(d, date, reset=false){\n    if(reset) sessions.resetDates();\n\n    let groups = Breaker(d, groupBy, date);\n    _.forEach(_.values(groups), (ses)=>{\n      sessions.addDate(ses.date, ses.sessions);\n    });\n\n\n\n    return sessions\n  };\n}\n\nfunction processDates(dates){\n  if(_.isEmpty(dates)) return dates;\n  let yesterday = new Date();\n  yesterday.setDate(yesterday.getDate()-1);\n  return _.filter(dates, (d)=>{\n    return d.date.getTime() >= yesterday.getTime();\n  })\n}\n\nfunction currentDate(date){\n  let current = (_.isDate(date)) ? date : new Date();\n\n  return {\n      getDate:()=>current\n    , setDate:(d)=>{\n      current = (_.isDate(d)) ? d : current;\n    }\n  }\n}\n\nconst store = {\n  // <<<<<<<<<<<<<<<< Event management >>>>>>>>>>\n  emitChange(event) {\n    this.emit(event);\n  }\n\n  , addChangeListener(event, callback) {\n    this.on(event, callback);\n  }\n\n  , removeChangeListener(event, callback) {\n    this.removeListener(event, callback);\n  }\n\n  // <<<<<<<<<<<<<<< Fetching and processing session >>>>>>>>>>>>\n  , _addSessions(data){\n\n    if(_.isFunction(processor)){\n      sessions = processor(data);\n    }\n  }\n\n  , _calendarChange(date){\n    this._setDate(date);\n    this._fetchData(date, true);\n  }\n\n  , _fetchData(date, reset=false){\n    if(!ajaxManager){\n      throw new Error(\"please set API path\")\n    }\n\n    ajaxManager.addQuery(date);\n    let request = ajaxManager.fetch();\n\n    if(request){\n      return request.then((data)=>{\n        fetched = true;\n        sessions = processor(data, date, reset);\n\n        this.emitChange(\"fetched\");\n\n        return sessions.getAllDates();\n      })\n      .then((data)=>{\n        this._fetchRest(data)\n        return data\n      });\n    }\n  }\n\n  , _fetchNowNext(){\n    let request = ajaxManager.fetch().then((data)=>{\n        fetched = true;\n        sessions = processor(data, false);\n\n        this.emitChange(\"fetched\");\n      });\n  }\n\n  , _fetchRest(dates){\n      let fetch = _.filter(dates, (d)=>d.nosessions)\n      fetch = _.reduce(fetch, (prev, curr)=>{\n        if(prev.date.getTime() > curr.date.getTime()){\n          return curr;\n        }\n\n        return prev;\n      });\n\n      if(fetch) this._fetchData(fetch.date)\n  }\n\n  , _getCurrentDate(){\n    return this.current.getDate()\n  }\n\n  , _getDate(date){\n    if(!this.current){\n      this.current = currentDate(date);\n    }\n    this.current.setDate(date);\n    if(sessions){\n      let current_day = sessions.findDate(this.current.getDate());\n      if(current_day) return current_day;\n    }\n\n    if(fetched){\n      this._fetchData(this.current.getDate());\n      this.emitChange(\"fetching\");\n    } else {\n      return []\n    }\n\n    return null;\n  }\n\n  , _getFacility(){\n    return sessions.findDate(new Date()).data.filter(\"facility\", facility)\n  }\n\n  , _getMoreDays(){\n\n    if(fetched){\n      let date = sessions.getMoreDays();\n      if(_.isDate(date)) this._fetchData(date)\n    }\n  }\n\n  , _getPreviousDays(date){\n    let d = sessions.getPreviousDays(date);\n    if(_.isDate(d)){\n      this._fetchData(d);\n    }\n  }\n\n  , _getAllDates(){\n    if(_.isUndefined(sessions)) return [new Date()]\n    return processDates(sessions.getAllDates());\n  }\n\n  , _setApi(api){\n    ajaxManager = AjaxManager(api);\n  }\n\n  , _setDate(date){\n    if(!this.current){\n      this.current = currentDate(date);\n    }\n    this.current.setDate(date);\n  }\n\n  , _setFacility(id){\n    facility = id;\n  }\n\n  , _setGroups(groupBy){\n    if(!_.isString(groupBy)) return;\n    processor = processData(groupBy);\n  }\n\n  , _progress(prog){\n    if(!_.isFunction(prog)) return;\n    this.progress = prog\n  }\n};\n\nconst SessionStore = assign({}, EventEmitter.prototype, store);\nSessionStore.setMaxListeners(0);\n\nconst registeredCallback = function(payload) {\n  var action = payload.action;\n  switch(action.type) {\n    case \"CHANGE_DATE\":\n      SessionStore._setDate(action.date);\n      SessionStore.emitChange(\"changing_date\");\n      break;\n    case \"CALENDAR_CHANGE\":\n      SessionStore._calendarChange(action.date);\n      SessionStore.emitChange(\"calendar_changing\");\n      break;\n    case \"FETCH_DATA\":\n      if(action.progress) SessionStore._progress(action.progress)\n      SessionStore._fetchData(action.date);\n      SessionStore.emitChange(\"fetching\");\n      break;\n\n    case \"FETCH_NOWNEXT\":\n      if(action.progress) SessionStore._progress(action.progress)\n      SessionStore._fetchNowNext();\n      SessionStore.emitChange(\"fetching_nownext\");\n      break;\n\n    case \"MORE_DAYS\":\n      SessionStore._getMoreDays();\n      SessionStore.emitChange(\"more_days\");\n      break;\n\n    case \"PREVIOUS_DAYS\":\n      SessionStore._getPreviousDays(action.date);\n      SessionStore.emitChange(\"previous_days\");\n      break;\n\n    case \"PRERENDER_DATA\":\n      SessionStore._addSessions(action.data);\n      SessionStore.emitChange(\"prerender\");\n      break;\n\n    case \"SET_FACILITY\":\n      SessionStore._setFacility(action.id);\n      SessionStore.emitChange(\"set_facility\");\n      break;\n\n    case \"SET_GROUPBY\":\n      SessionStore._setGroups(action.groupBy);\n      SessionStore.emitChange(\"groupby\");\n      break;\n    case \"SET_API\":\n      SessionStore._setApi(action.url);\n      SessionStore.emitChange(\"api_set\");\n\n      break;\n\n  }\n};\n\nSessionStore.dispatchToken = SessionsDispatcher.register(registeredCallback);\nSessionStore.setMaxListeners(0);\n\nmodule.exports = SessionStore;"]}