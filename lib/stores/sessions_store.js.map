{"version":3,"sources":["../../src/stores/sessions_store.js"],"names":[],"mappings":"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","file":"sessions_store.js","sourcesContent":["const assign      = require(\"react/lib/Object.assign\")\n  , EventEmitter  = require(\"events\").EventEmitter\n  , _             = require(\"lodash\");\n\n//Internal Modules\nconst AjaxManager  = require(\"../utils/ajax_manager\")\n    , DateManager  = require(\"../factories/date_manager\")\n    , SessionsFcty = require(\"../factories/sessions_fcty\")\n    , Breaker      = require(\"../utils/sessions_breaker\")\n    , checker      = require(\"../utils/day_checker\");\n\n\n//Flux\nconst SessionsDispatcher = require(\"../dispatchers/sessions_dispatcher\")\n    , SessionsAction     = require(\"../actions/sessions_actions\");\n\nlet ajaxManager, processor, sessions, facility;\n\nlet fetched     = false;\nlet requestMade = false;\n\nfunction processData(groupBy){\n\n  let sessions = DateManager(groupBy);\n\n  return function(d, reset=false){\n    if(reset) sessions.resetDates();\n\n    let groups = Breaker(d, groupBy);\n    _.forEach(_.values(groups), (ses)=>{\n      sessions.addDate(ses.date, ses.sessions);\n    });\n\n    return sessions\n  };\n}\n\nfunction processDates(dates){\n  let yesterday = new Date();\n  yesterday.setDate(yesterday.getDate()-1);\n  return _.filter(dates, (d)=>{\n    return d.date.getTime() >= yesterday.getTime();\n  })\n}\n\nfunction currentDate(date){\n  let current = (_.isDate(date)) ? date : new Date();\n\n  return {\n      getDate:()=>current\n    , setDate:(d)=>{\n      current = (_.isDate(d)) ? d : current;\n    }\n  }\n}\n\nconst store = {\n  // <<<<<<<<<<<<<<<< Event management >>>>>>>>>>\n  emitChange(event) {\n    this.emit(event);\n  }\n\n  , addChangeListener(event, callback) {\n    this.on(event, callback);\n  }\n\n  , removeChangeListener(event, callback) {\n    this.removeListener(event, callback);\n  }\n\n  // <<<<<<<<<<<<<<< Fetching and processing session >>>>>>>>>>>>\n  , _addSessions(data){\n    if(_.isFunction(processor)){\n      sessions = processor(data);\n    }\n  }\n\n  , _calendarChange(date){\n    this._setDate(date);\n    this._fetchData(date, true);\n  }\n\n  , _fetchData(date, reset=false){\n    if(!ajaxManager){\n      throw new Error(\"please set API path\")\n    }\n\n    ajaxManager.addQuery(date);\n    let request = ajaxManager.fetch();\n\n    if(request){\n      return request.then((data)=>{\n        fetched = true;\n        sessions = processor(data, reset);\n\n        this.emitChange(\"fetched\");\n\n        return sessions.getAllDates();\n      })\n      .then(this._fetchRest.bind(this));\n    }\n  }\n\n  , _fetchNowNext(){\n    let request = ajaxManager.fetch().then((data)=>{\n        fetched = true;\n        sessions = processor(data, false);\n\n        this.emitChange(\"fetched\");\n      });\n  }\n\n  , _fetchRest(dates){\n      let fetch = _.filter(dates, (d)=>d.nosessions)\n      fetch = _.reduce(fetch, (prev, curr)=>{\n        if(prev.date.getTime() > curr.date.getTime()){\n          return curr;\n        }\n\n        return prev;\n      });\n\n      if(fetch) this._fetchData(fetch.date)\n  }\n\n  , _getCurrentDate(){\n    return this.current.getDate()\n  }\n\n  , _getDate(date){\n    if(!this.current){\n      this.current = currentDate(date);\n    }\n    this.current.setDate(date);\n    if(sessions){\n      let current_day = sessions.findDate(this.current.getDate());\n      if(current_day) return current_day;\n    }\n\n    if(fetched){\n      this._fetchData(this.current.getDate());\n      this.emitChange(\"fetching\");\n    } else {\n      return []\n    }\n\n    return null;\n  }\n\n  , _getFacility(){\n    return sessions.findDate(new Date()).data.filter(\"facility\", facility)\n  }\n\n  , _getMoreDays(){\n\n    if(fetched){\n      let date = sessions.getMoreDays();\n      if(_.isDate(date)) this._fetchData(date)\n    }\n  }\n\n  , _getPreviousDays(date){\n    let d = sessions.getPreviousDays(date);\n    if(_.isDate(d)){\n      this._fetchData(d);\n    }\n  }\n\n  , _getAllDates(){\n    return processDates(sessions.getAllDates());\n  }\n\n  , _setApi(api){\n    ajaxManager = AjaxManager(api);\n  }\n\n  , _setDate(date){\n    if(!this.current){\n      this.current = currentDate(date);\n    }\n    this.current.setDate(date);\n  }\n\n  , _setFacility(id){\n    facility = id;\n  }\n\n  , _setGroups(groupBy){\n    if(_.isString(groupBy)){\n      processor = processData(groupBy);\n    }\n  }\n\n  , _progress(prog){\n    this.progress = prog\n  }\n};\n\nconst SessionStore = assign({}, EventEmitter.prototype, store);\nSessionStore.setMaxListeners(0);\n\nconst registeredCallback = function(payload) {\n  var action = payload.action;\n  switch(action.type) {\n    case \"CHANGE_DATE\":\n      SessionStore._setDate(action.date);\n      SessionStore.emitChange(\"changing_date\");\n      break;\n    case \"CALENDAR_CHANGE\":\n      SessionStore._calendarChange(action.date);\n      SessionStore.emitChange(\"calendar_changing\");\n      break;\n    case \"FETCH_DATA\":\n      if(action.progress) SessionStore._progress(action.progress)\n      SessionStore._fetchData(action.date);\n      SessionStore.emitChange(\"fetching\");\n      break;\n\n    case \"FETCH_NOWNEXT\":\n      if(action.progress) SessionStore._progress(action.progress)\n      SessionStore._fetchNowNext();\n      SessionStore.emitChange(\"fetching_nownext\");\n      break;\n\n    case \"MORE_DAYS\":\n      SessionStore._getMoreDays();\n      SessionStore.emitChange(\"more_days\");\n      break;\n\n    case \"PREVIOUS_DAYS\":\n      SessionStore._getPreviousDays(action.date);\n      SessionStore.emitChange(\"previous_days\");\n      break;\n\n    case \"PRERENDER_DATA\":\n      SessionStore._addSessions(action.data);\n      SessionStore.emitChange(\"prerender\");\n      break;\n\n    case \"SET_FACILITY\":\n      SessionStore._setFacility(action.id);\n      SessionStore.emitChange(\"set_facility\");\n      break;\n\n    case \"SET_GROUPBY\":\n      SessionStore._setGroups(action.groupBy);\n      SessionStore.emitChange(\"groupby\");\n      break;\n    case \"SET_API\":\n      SessionStore._setApi(action.url);\n      SessionStore.emitChange(\"api_set\");\n\n      break;\n\n  }\n};\n\nSessionStore.dispatchToken = SessionsDispatcher.register(registeredCallback);\nSessionStore.setMaxListeners(0);\n\nmodule.exports = SessionStore;"]}