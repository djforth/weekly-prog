{"version":3,"sources":["../../src/stores/sessions_store.js"],"names":[],"mappings":"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","file":"sessions_store.js","sourcesContent":["var AjaxManager, Breaker, DateManager, EventEmitter, SessionsDispatcher, _;\n\nlet ajaxManager, processor, sessions, facility, fetched;\n\nEventEmitter = require('events').EventEmitter;\n_ = require('lodash/core');\n\n// Internal Modules\nAjaxManager  = require('../utils/ajax_manager');\nDateManager  = require('../factories/date_manager');\nBreaker      = require('../utils/sessions_breaker');\n\n// Flux\nSessionsDispatcher = require('../dispatchers/sessions_dispatcher');\n\nfetched     = false;\n\nfunction processData(groupBy){\n  let sessions = DateManager(groupBy);\n\n  return function(d, date, reset = false){\n    if (reset) sessions.resetDates();\n\n    let groups = Breaker(d, groupBy, date);\n    _.forEach(_.values(groups), (ses)=>{\n      sessions.addDate(ses.date, ses.sessions);\n    });\n\n    return sessions;\n  };\n}\n\nfunction processDates(dates){\n  if (_.isEmpty(dates)) return dates;\n  let yesterday = new Date();\n  yesterday.setDate(yesterday.getDate() - 1);\n  return _.filter(dates, (d)=>{\n    return d.date.getTime() >= yesterday.getTime();\n  });\n}\n\nfunction currentDate(date){\n  let current = (_.isDate(date)) ? date : new Date();\n\n  return {\n    getDate: ()=>current\n    , setDate: (d)=>{\n      current = (_.isDate(d)) ? d : current;\n    }\n  };\n}\n\nconst store = {\n  // <<<<<<<<<<<<<<<< Event management >>>>>>>>>>\n  emitChange(event){\n    this.emit(event);\n  }\n\n  , addChangeListener(event, callback){\n    this.on(event, callback);\n  }\n\n  , removeChangeListener(event, callback){\n    this.removeListener(event, callback);\n  }\n\n  // <<<<<<<<<<<<<<< Fetching and processing session >>>>>>>>>>>>\n  , _addSessions(data){\n    if (_.isFunction(processor)){\n      sessions = processor(data);\n    }\n  }\n\n  , _calendarChange(date){\n    this._setDate(date);\n    this._fetchData(date, true);\n  }\n\n  , _fetchData(date, reset = false){\n    if (!ajaxManager){\n      throw new Error('please set API path');\n    }\n\n    ajaxManager.addQuery(date);\n    let request = ajaxManager.fetch();\n\n    if (request){\n      return request.then((data)=>{\n        fetched = true;\n        sessions = processor(data, date, reset);\n\n        this.emitChange('fetched');\n\n        return sessions.getAllDates();\n      })\n      .then((data)=>{\n        this._fetchRest(data);\n        return data;\n      });\n    }\n  }\n\n  , _fetchNowNext(){\n    ajaxManager.fetch().then((data)=>{\n      fetched = true;\n      sessions = processor(data, false);\n\n      this.emitChange('fetched');\n    });\n  }\n\n  , _fetchRest(dates){\n    let fetch = _.filter(dates, (d)=>d.nosessions);\n    fetch = _.reduce(fetch, (prev, curr)=>{\n      if (prev.date.getTime() > curr.date.getTime()){\n        return curr;\n      }\n\n      return prev;\n    });\n\n    if (fetch) this._fetchData(fetch.date);\n  }\n\n  , _getCurrentDate(){\n    return this.current.getDate();\n  }\n\n  , _getDate(date){\n    if (!this.current){\n      this.current = currentDate(date);\n    }\n    this.current.setDate(date);\n    if (sessions){\n      let current_day = sessions.findDate(this.current.getDate());\n      if (current_day) return current_day;\n    }\n\n    if (fetched){\n      this._fetchData(this.current.getDate());\n      this.emitChange('fetching');\n    } else {\n      return [];\n    }\n\n    return null;\n  }\n\n  , _getFacility(){\n    return sessions.findDate(new Date()).data.filter('facility', facility);\n  }\n\n  , _getMoreDays(){\n    if (fetched){\n      let date = sessions.getMoreDays();\n      if (_.isDate(date)) this._fetchData(date);\n    }\n  }\n\n  , _getPreviousDays(date){\n    let d = sessions.getPreviousDays(date);\n    if (_.isDate(d)){\n      this._fetchData(d);\n    }\n  }\n\n  , _getAllDates(){\n    if (_.isUndefined(sessions)) return [new Date()];\n    return processDates(sessions.getAllDates());\n  }\n\n  , _setApi(api){\n    ajaxManager = AjaxManager(api);\n  }\n\n  , _setDate(date){\n    if (!this.current){\n      this.current = currentDate(date);\n    }\n    this.current.setDate(date);\n  }\n\n  , _setFacility(id){\n    facility = id;\n  }\n\n  , _setGroups(groupBy){\n    if (!_.isString(groupBy)) return;\n    processor = processData(groupBy);\n  }\n\n  , _progress(prog){\n    if (!_.isFunction(prog)) return;\n    this.progress = prog;\n  }\n};\n\nconst SessionStore = Object.assign({}, EventEmitter.prototype, store);\nSessionStore.setMaxListeners(0);\n\nconst registeredCallback = function(payload){\n  var action = payload.action;\n  switch(action.type){\n    case 'CHANGE_DATE':\n      SessionStore._setDate(action.date);\n      SessionStore.emitChange('changing_date');\n      break;\n    case 'CALENDAR_CHANGE':\n      SessionStore._calendarChange(action.date);\n      SessionStore.emitChange('calendar_changing');\n      break;\n    case 'FETCH_DATA':\n      if (action.progress) SessionStore._progress(action.progress);\n      SessionStore._fetchData(action.date);\n      SessionStore.emitChange('fetching');\n      break;\n\n    case 'FETCH_NOWNEXT':\n      if (action.progress) SessionStore._progress(action.progress);\n      SessionStore._fetchNowNext();\n      SessionStore.emitChange('fetching_nownext');\n      break;\n\n    case 'MORE_DAYS':\n      SessionStore._getMoreDays();\n      SessionStore.emitChange('more_days');\n      break;\n\n    case 'PREVIOUS_DAYS':\n      SessionStore._getPreviousDays(action.date);\n      SessionStore.emitChange('previous_days');\n      break;\n\n    case 'PRERENDER_DATA':\n      SessionStore._addSessions(action.data);\n      SessionStore.emitChange('prerender');\n      break;\n\n    case 'SET_FACILITY':\n      SessionStore._setFacility(action.id);\n      SessionStore.emitChange('set_facility');\n      break;\n\n    case 'SET_GROUPBY':\n      SessionStore._setGroups(action.groupBy);\n      SessionStore.emitChange('groupby');\n      break;\n    case 'SET_API':\n      SessionStore._setApi(action.url);\n      SessionStore.emitChange('api_set');\n\n      break;\n    default:\n      throw (new Error('No Action'));\n  }\n};\n\nSessionStore.dispatchToken = SessionsDispatcher.register(registeredCallback);\nSessionStore.setMaxListeners(0);\n\nmodule.exports = SessionStore;\n"]}