{"version":3,"sources":["../../src/stores/sessions_store.js"],"names":[],"mappings":"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","file":"sessions_store.js","sourcesContent":["var AjaxManager, Breaker, DateManager, EventEmitter, SessionsDispatcher, _;\n\nlet ajaxManager, processor, sessions, facility, fetched;\n\nEventEmitter = require('events').EventEmitter;\n_ = require('lodash/core');\n\n// Internal Modules\nAjaxManager  = require('../utils/ajax_manager');\nDateManager  = require('../factories/date_manager');\nBreaker      = require('../utils/sessions_breaker');\n\n// Flux\nSessionsDispatcher = require('../dispatchers/sessions_dispatcher');\n\nfetched     = false;\n\nfunction processData(groupBy){\n  let sessions = DateManager(groupBy);\n\n  return function(d, date, reset = false){\n    if (reset) sessions.resetDates();\n\n    let groups = Breaker(d, groupBy, date);\n    _.forEach(_.values(groups), (ses)=>{\n      sessions.addDate(ses.date, ses.sessions);\n    });\n\n    return sessions;\n  };\n}\n\nfunction processDates(dates){\n  if (_.isEmpty(dates)) return dates;\n  let yesterday = new Date();\n  yesterday.setDate(yesterday.getDate() - 1);\n  return _.filter(dates, (d)=>{\n    return d.date.getTime() >= yesterday.getTime();\n  });\n}\n\nfunction currentDate(date){\n  let current = (_.isDate(date)) ? date : new Date();\n\n  return {\n    getDate: ()=>current\n    , setDate: (d)=>{\n      current = (_.isDate(d)) ? d : current;\n    }\n  };\n}\n\nconst store = {\n  // <<<<<<<<<<<<<<<< Event management >>>>>>>>>>\n  emitChange(event){\n    this.emit(event);\n  }\n\n  , addChangeListener(event, callback){\n    this.on(event, callback);\n  }\n\n  , removeChangeListener(event, callback){\n    this.removeListener(event, callback);\n  }\n\n  // <<<<<<<<<<<<<<< Fetching and processing session >>>>>>>>>>>>\n  , _addSessions(data){\n    if (_.isFunction(processor)){\n      sessions = processor(data);\n    }\n  }\n\n  , _calendarChange(date){\n    this._setDate(date);\n    this._fetchData(date, true);\n  }\n\n  , _fetchData(date, reset = false){\n    if (!ajaxManager){\n      throw new Error('please set API path');\n    }\n\n    ajaxManager.addQuery(date);\n    let request = ajaxManager.fetch();\n\n    if (request){\n      return request.then((data)=>{\n        fetched = true;\n        sessions = processor(data, date, reset);\n\n        this.emitChange('fetched');\n\n        return sessions.getAllDates();\n      })\n      .then((data)=>{\n        this._fetchRest(data);\n        return data;\n      });\n    }\n  }\n\n  , _fetchNowNext(){\n    ajaxManager.fetch().then((data)=>{\n      fetched = true;\n      sessions = processor(data, false);\n\n      this.emitChange('fetched');\n    });\n  }\n\n  , _fetchRest(dates){\n    let fetch = _.filter(dates, (d)=>d.nosessions);\n    fetch = _.reduce(fetch, (prev, curr)=>{\n      if (prev.date.getTime() > curr.date.getTime()){\n        return curr;\n      }\n\n      return prev;\n    });\n\n    if (fetch) this._fetchData(fetch.date);\n  }\n\n  , _getCurrentDate(){\n    return this.current.getDate();\n  }\n\n  , _getDate(date){\n    if (!this.current){\n      this.current = currentDate(date);\n    }\n    this.current.setDate(date);\n    if (sessions){\n      let current_day = sessions.findDate(this.current.getDate());\n      if (current_day) return current_day;\n    }\n\n    if (fetched){\n      this._fetchData(this.current.getDate());\n      this.emitChange('fetching');\n    } else {\n      return [];\n    }\n\n    return null;\n  }\n\n  , _getFacility(){\n    return sessions.findDate(new Date()).data.filter('facility', facility);\n  }\n\n  , _getMoreDays(){\n    if (fetched){\n      let date = sessions.getMoreDays();\n      if (_.isDate(date)) this._fetchData(date);\n    }\n  }\n\n  , _getPreviousDays(date){\n    let d = sessions.getPreviousDays(date);\n    if (_.isDate(d)){\n      this._fetchData(d);\n    }\n  }\n\n  , _getAllDates(){\n    if (_.isUndefined(sessions)) return [new Date()];\n    return processDates(sessions.getAllDates());\n  }\n\n  , _setApi(api){\n    ajaxManager = AjaxManager(api);\n  }\n\n  , _setDate(date){\n    if (!this.current){\n      this.current = currentDate(date);\n    }\n    this.current.setDate(date);\n  }\n\n  , _setFacility(id){\n    facility = id;\n  }\n\n  , _setGroups(groupBy){\n    if (!_.isString(groupBy)) return;\n    processor = processData(groupBy);\n  }\n\n  , _progress(prog){\n    if (!_.isFunction(prog)) return;\n    this.progress = prog;\n  }\n};\n\nconst SessionStore = Object.assign({}, EventEmitter.prototype, store);\nSessionStore.setMaxListeners(0);\n\nconst registeredCallback = function(payload){\n  var action = payload.action;\n  switch(action.type){\n    case 'CHANGE_DATE':\n      SessionStore._setDate(action.date);\n      SessionStore.emitChange('changing_date');\n      break;\n    case 'CALENDAR_CHANGE':\n      SessionStore._calendarChange(action.date);\n      SessionStore.emitChange('calendar_changing');\n      break;\n    case 'FETCH_DATA':\n      if (action.progress) SessionStore._progress(action.progress);\n      SessionStore._fetchData(action.date);\n      SessionStore.emitChange('fetching');\n      break;\n\n    case 'FETCH_NOWNEXT':\n      if (action.progress) SessionStore._progress(action.progress);\n      SessionStore._fetchNowNext();\n      SessionStore.emitChange('fetching_nownext');\n      break;\n\n    case 'MORE_DAYS':\n      SessionStore._getMoreDays();\n      SessionStore.emitChange('more_days');\n      break;\n\n    case 'PREVIOUS_DAYS':\n      SessionStore._getPreviousDays(action.date);\n      SessionStore.emitChange('previous_days');\n      break;\n\n    case 'PRERENDER_DATA':\n      SessionStore._addSessions(action.data);\n      SessionStore.emitChange('prerender');\n      break;\n\n    case 'SET_FACILITY':\n      SessionStore._setFacility(action.id);\n      SessionStore.emitChange('set_facility');\n      break;\n\n    case 'SET_GROUPBY':\n      SessionStore._setGroups(action.groupBy);\n      SessionStore.emitChange('groupby');\n      break;\n    case 'SET_API':\n      SessionStore._setApi(action.url);\n      SessionStore.emitChange('api_set');\n\n      break;\n    default:\n      throw (new Error('No Action'));\n  }\n};\n\nSessionStore.dispatchToken = SessionsDispatcher.register(registeredCallback);\nSessionStore.setMaxListeners(0);\n\nmodule.exports = SessionStore;\n"]}